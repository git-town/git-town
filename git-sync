#!/bin/bash
source "$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/helpers/helpers.sh"


# Perform the sync operation
function perform_sync {
  if [ "$initial_open_changes" = true ]; then
    add_to_command_list "stash_open_changes"
  fi

  if [ "$(is_feature_branch "$initial_branch_name")" = true ]; then
    add_to_command_list "checkout_main_branch"
  fi

  add_to_command_list "fetch_repo"
  add_to_command_list "rebase_tracking_branch"
  add_to_command_list "push_branch"

  if [ "$(is_feature_branch "$initial_branch_name")" = true ]; then
    add_to_command_list "checkout_branch $initial_branch_name"
    add_to_command_list "merge_tracking_branch"
    add_to_command_list "merge_branch $main_branch_name"
    add_to_command_list "push_branch"
  else
    add_to_command_list "push_tags"
  fi

  if [ "$initial_open_changes" = true ]; then
    add_to_command_list "restore_open_changes"
  fi

  execute_command_list
}


if [ "$1" == "--abort" ]; then
  run_abort_script
elif [ "$1" == "--continue" ]; then
  ensure_no_conflicts "You must resolve the conflicts before continuing the git sync"
  execute_command_list
else
  remove_scripts
  perform_sync
fi

exit_with_success
