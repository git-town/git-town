#!/bin/bash
source "$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/helpers/helpers.sh"

undo_script_filename=`undo_script_filename_for_command kill`

function create_undo_script {
  local current_sha=`sha_of_branch $initial_branch_name`
  add_to_undo_script "create_and_checkout_branch $initial_branch_name $current_sha"
  if [ $initial_open_changes == true ]; then
    add_to_undo_script "reset_to_sha $original_branch_sha"
  fi
  if [ `has_tracking_branch $initial_branch_name` == true ]; then
    add_to_undo_script "push_branch"
  fi
}


function perform_kill {
  ensure_on_feature_branch "You can only kill feature branches."
  original_branch_sha=`sha_of_branch $initial_branch_name`

  # Remove open changes
  if [ $initial_open_changes == true ]; then
    run_command "git add -A"
    run_command "git commit -m 'open changes'"
  fi

  create_undo_script

  checkout_main_branch
  delete_branch $initial_branch_name force
}


if [ "$1" == "--undo" ]; then
  run_undo_script
else
  perform_kill "$*"
fi

exit_with_success
