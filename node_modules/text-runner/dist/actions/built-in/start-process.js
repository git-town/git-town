"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const colorette_1 = __importDefault(require("colorette"));
const observable_process_1 = require("observable-process");
const path_1 = __importDefault(require("path"));
const call_args_1 = require("../helpers/call-args");
const running_process_1 = require("../helpers/running-process");
const trim_dollar_1 = require("../helpers/trim-dollar");
/**
 * The "startProcess" action runs the given commands on the console.
 * It leaves the command running.
 */
async function startProcess(args) {
    const commandsToRun = getCommandsToRun(args);
    args.name(`starting a long-running process: ${colorette_1.default.bold(colorette_1.default.cyan(commandsToRun))}`);
    running_process_1.RunningProcess.instance().set(observable_process_1.createObservableProcess(call_args_1.callArgs(commandsToRun), {
        cwd: args.configuration.workspace
    }));
}
exports.default = startProcess;
function getCommandsToRun(args) {
    return args.nodes
        .textInNodeOfType("fence")
        .split("\n")
        .map(line => line.trim())
        .filter(line => line)
        .map(trim_dollar_1.trimDollar)
        .map(makeGlobal(args.configuration))
        .join(" && ");
}
function makeGlobal(configuration) {
    configuration = configuration || {};
    let globals = {};
    try {
        globals = configuration.actions.runConsoleCommand.globals;
    }
    catch (e) {
        // we can ignore null-pointer exceptions here since we have a default value
    }
    return function (commandText) {
        const commandParts = commandText.split(" ");
        const command = commandParts[0];
        const replacement = globals[command];
        if (replacement) {
            return path_1.default.join(configuration.sourceDir, replacement) + " " + commandParts.splice(1).join(" ");
        }
        else {
            return commandText;
        }
    };
}
//# sourceMappingURL=start-process.js.map