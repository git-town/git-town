#!/usr/bin/env bash
source "$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/helpers/helpers.sh"


# Echoes the names of all branches that should be synced in the current session
function branches_to_sync {
  if [ "$sync_all" = true ]; then
    echo "$MAIN_BRANCH_NAME"
    local_branches_without_main
  elif [ "$syncing_feature_branch" = true ]; then
    parent_branches "$INITIAL_BRANCH_NAME"
    echo "$INITIAL_BRANCH_NAME"
  elif [ "$syncing_non_feature_branch" = true ]; then
    echo "$INITIAL_BRANCH_NAME"
  else
    echo_error_header "Unknown internal state, please report this bug"
    exit_with_error
  fi
}


function preconditions {
  if [ "$HAS_REMOTE" = true ]; then
    fetch
  fi

  should_push_tags=false
  sync_all=false
  syncing_feature_branch=false
  syncing_non_feature_branch=false

  if [ "$1" = "--all" ]; then
    sync_all=true
  elif [ "$(is_feature_branch "$INITIAL_BRANCH_NAME")" = true ]; then
    syncing_feature_branch=true
    ensure_knows_parent_branches "$INITIAL_BRANCH_NAME"
  else
    syncing_non_feature_branch=true
    should_push_tags=true
  fi
}


function skip_message_prefix {
  echo "To skip the sync of the '$(get_current_branch_name)' branch"
}


function skippable {
  if [ "$(rebase_in_progress)" = true ] && [ "$(get_current_branch_name)" = "$MAIN_BRANCH_NAME" ]; then
    echo false
  else
    echo true
  fi
}


function steps {
  echo_if_true "change_directory $(git_root)" "$IN_SUB_FOLDER"
  echo_if_true "stash_open_changes" "$INITIAL_OPEN_CHANGES"

  branches_to_sync | while read branch_name; do
    sync_branch_steps "$branch_name"
  done

  if [ "$HAS_REMOTE" = true ] && [ "$should_push_tags" = true ]; then
    echo "push_tags"
  fi

  echo "checkout $INITIAL_BRANCH_NAME"

  echo_if_true "restore_open_changes" "$INITIAL_OPEN_CHANGES"
  echo_if_true "change_directory $INITIAL_DIRECTORY" "$IN_SUB_FOLDER"
}


run "$@"
