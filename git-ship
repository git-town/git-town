#!/bin/bash
source "$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/helpers/helpers.sh"


abort_script=`abort_filename "ship"`


# Exit if the current branch is not ahead of main
function ensure_ahead_of_main_branch {
  local current_branch_name=`get_current_branch_name`
  if [ `is_ahead_of_main $current_branch_name` == false ]; then
    echo_error_header
    echo_error "The current branch '$current_branch_name' has no commits to merge into '$main_branch_name'."
    exit_with_error
  fi
}


# Called by pull_branch when the merge fails with conflicts on the feature branch
function error_pull_feature_branch {
  # Create the abort file.
  echo "git merge --abort" > $abort_script
  if [ $initial_open_changes == true ]; then
    echo "git stash pop" >> $abort_script
  fi

  # Show error message.
  echo
  echo_red 'To abort the merge, run "git ship --abort".'
  exit_with_error
}


# Called by pull_branch when the rebase fails with conflicts on the main branch
function error_pull_main_branch {
  # Create the abort file.
  echo "git rebase --abort" > $abort_script
  echo "git checkout $initial_branch_name" >> $abort_script
  if [ $initial_open_changes == true ]; then
    echo "git stash pop" >> $abort_script
  fi

  # Show error message.
  echo
  echo_red 'To abort the rebase and checkout the original branch, run "git ship --abort".'
  exit_with_error
}


# Called by merge_branch when the merge fails with merge conflicts
function error_merge_branch {
  # Create the abort file
  echo "git merge --abort" > $abort_script
  if [ $initial_open_changes == true ]; then
    echo "git stash pop" >> $abort_script
  fi

  # Show error message.
  echo
  echo_red 'To abort the merge and checkout the original branch, run "git ship --abort".'
  exit_with_error
}


# Parses the options and reruns the message
function extract_message {
  message=''

  while getopts "m::" opt; do
    case "$opt" in
    m) message=$OPTARG
    esac
  done

  echo $message
}


function perform_ship {
  local message=`extract_message "$*"`

  ensure_no_open_changes "You should not ship while having open files in Git."
  ensure_on_feature_branch "Please checkout a feature branch to ship."

  sync_main_branch
  pull_branch
  merge_branch $main_branch_name
  ensure_ahead_of_main_branch
  checkout_main_branch
  squash_merge $initial_branch_name "$message"
  push_branch
  delete_branch $initial_branch_name
}


if [ "$1" == "--abort" ]; then
  run_abort_script
else
  perform_ship "$*"
fi

exit_with_success
