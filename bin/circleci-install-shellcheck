#!/usr/bin/env bash
set -e


# Installs ShellCheck on CircleCI if necessary,
# removes older versions.


# the current version of shellcheck
VERSION=0.3.7

# path to the cached ShellCheck binary
BIN_PATH=~/.cabal/bin/shellcheck


# Installs the current version of ShellCheck
function install_shellcheck {
  echo "Installing ShellCheck $VERSION"
  cabal update --verbose=0
  cabal install --verbose=0 shellcheck-$VERSION
}


function currently_installed_shell_check_version {
  $BIN_PATH -V | grep version: | cut -d: -f2 | awk '{print $1}'
}


if [ ! -f $BIN_PATH ]; then
  echo "No ShellCheck found"
  install_shellcheck
else
  if [ "$VERSION" != "currently_installed_shell_check_version" ]; then
    echo "An older version of ShellCheck was found"
    rm -rf $BIN_PATH
    install_shellcheck
  else
    echo "Using cached shellcheck"
  fi
fi
