#!/bin/bash
source "$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/helpers/helpers.sh"


# Called when rebase_branch fails on the main branch
function error_rebase_branch {
  create_rebase_conflict_abort_script
  exit_with_script_messages
}


function perform_hack {
  target_branch_name=$1

  # Exit with a help screen if parameters are missing.
  if [ -z "$target_branch_name" ]; then
    echo_usage_header
    echo_usage "git hack [feature branch name]"
    exit_with_error
  fi

  ensure_does_not_have_branch "$target_branch_name"
  stash_open_changes
  checkout_main_branch
  fetch_repo
  rebase_tracking_branch
  push_branch
  create_and_checkout_feature_branch "$target_branch_name"
  restore_open_changes
}


if [ "$1" == "--abort" ]; then
  run_abort_script
else
  perform_hack "$*"
fi

exit_with_success
